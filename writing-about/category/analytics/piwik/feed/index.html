<!--?xml version="1.0" encoding="UTF-8"?--><html><head></head><body><rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:wfw="http://wellformedweb.org/CommentAPI/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:sy="http://purl.org/rss/1.0/modules/syndication/" xmlns:slash="http://purl.org/rss/1.0/modules/slash/">

<channel>
	<title>Piwik – Romaric Pascal</title>
	<atom:link href="/writing-about/category/analytics/piwik/feed/" rel="self" type="application/rss+xml">
	<link>
	<description>Lettering &#x26; web development</description>
	<lastbuilddate>Thu, 13 Feb 2020 11:35:45 +0000</lastbuilddate>
	<language>en-US</language>
	<sy:updateperiod>hourly</sy:updateperiod>
	<sy:updatefrequency>1</sy:updatefrequency>
	<generator>https://wordpress.org/?v=4.8.13</generator>
	<item>
		<title>Setting up Piwik log analytics on an OVH shared hosting</title>
		<link>/writing-about/setting-up-piwik-log-analytics-on-an-ovh-shared-hosting/
		<pubdate>Wed, 22 Mar 2017 13:26:42 +0000</pubdate>
		<dc:creator><!--[CDATA[romaricpascal]]--></dc:creator>
				<category><!--[CDATA[Analytics]]--></category>
		<category><!--[CDATA[Piwik]]--></category>
		<description><!--[CDATA[<article class="markdown-body"-->Analytics help you see how users interact with your website. This can help identify which topics they are most interested in, or which step or your sales funnel has most users give up on buying your product. I’ve recently set up <a href="https://piwik.org">Piwik</a> to keep an eye on the traffic on my website using their <a href="https://piwik.org/log-analytics/">log analytics feature</a>, automatically importing the previous days log into the tool every night. There were 4 main steps to getting it working:<p></p>
<ol>
<li>Hosting Piwik</li>
<li>Writing a script to import the log into Piwik</li>
<li>Writing a script to download the logs automatically</li>
<li>Setting up a Cron job to run the combination of both scripts every night</li>
</ol>
<h2 id="piwik-not-google-analytics"><a class="headeranchor-link" href="#piwik-not-google-analytics" name="user-content-piwik-not-google-analytics"></a>Piwik, not Google Analytics</h2>
<p>The most famous tool in this area is Google Analytics. While powerful, it sends data from the visitors of my site to a 3rd party (Google) whose business is selling ads by tracking people around the web. That makes me a bit wary regarding users’ privacy.</p>
<p>To keep control of that data, a strong alternative is <a href="https://piwik.org">Piwik</a>. It’s open-source and free to host on your own servers. This put you in control of the collected data and the respect of your users’ privacy (Do Not Track browser setting, IP Anonymisation…).</p>
<p>There are different ways to go for it. Similar to Google Analytics, you can embed a piece of JavaScript on your pages which will notify Piwik when users visit them. Or you can feed Piwik your server logs. As my website doesn’t have other client side interactions to track, nor does it load much content via JavaScript, log analytics would be enough. One less script to download for the users, no tracking cookie, and additionally, I’ll be able to see requests for non-existing pages. This might allow me to detect when something breaks. Though at the moment, it mostly shows me where attackers are trying to poke for WordPress or its plugins vulnerabilities.</p>
<h2 id="hosting-piwik"><a class="headeranchor-link" href="#hosting-piwik" name="user-content-hosting-piwik"></a>Hosting Piwik</h2>
<p>The first step is obviously to get Piwik running, ideally hosted on a separate vhost and with a separate database from your main website. After creating a new site and database on OVH’s hosting admin panel, Piwik’s installation is pretty straightforward following their <a href="https://piwik.org/docs/installation/">user guide</a>.</p>
<p>With Piwik ready to receive data, let’s work backward and look first at how to feed it the logs.</p>
<h2 id="importing-the-logs-in-piwik"><a class="headeranchor-link" href="#importing-the-logs-in-piwik" name="user-content-importing-the-logs-in-piwik"></a>Importing the logs in Piwik</h2>
<p>Along with the PHP file providing the UI and endpoint for the JS tracker, Piwik also provides a Python Script for importing logs into it. All our import script needs to do is configure the command with the appropriate options.</p>
<p><script src="https://gist.github.com/rhumaric/1cbbc162d2b129b2910701b61d903382.js?file=piwik-import.sh"></script></p>
<p>The script requires some kind of authentication to import the data into Piwik. Either the login/password combination you use to login to the UI, or an auth token that you can generate from the Piwik UI. Either way, these are kept our of the script to make it portable, and the appropriate flags (<code>--login</code> &#x26; <code>--password</code>, or <code>--token-auth</code>) are stored in a separate <code>.piwikauth</code> file.</p>
<p>The tool also needed a bit of help to parse the logs. The log format for OVH’s shared hosting doesn’t match exactly one of the well-know log formats supported by the import tool. This prevented the script from extracting the host information from the script, so a specific regex had to be provided with <code>--log-format-regex</code>.</p>
<p>With the host information at hand, the tool could now generate Piwik sites for each host encountered in the log thanks to the <code>--add-sites-new-hosts</code>. If you’re only interested in specific hosts, you can filter the logs with the <code>--hostname</code> option.</p>
<p>Last, Piwik import tool will ignore static file downloads, HTTP redirects, and HTTP errors by default. It provides <code>--enable-&#x3C;XYZ></code> flags to include them in the import, though. Redirects added too much noise to the stats, but HTTP errors were definitely something I’m interested in. And I’m thinking downloads could help have a view of the RSS feed audience (tracking a query parameter on images loaded from RSS, for example) so I kept them too.</p>
<p>But to import logs into Piwik… well… we need logs. Let’s see how to collect them.</p>
<h2 id="downloading-ovh-logs"><a class="headeranchor-link" href="#downloading-ovh-logs" name="user-content-downloading-ovh-logs"></a>Downloading OVH logs</h2>
<p>For shared hostings, OVH provides access to GZipped versions of the Apache logs. Of course, they are not publicly accessible. In the “Statistics and logs” section of the hosting admin panel, you can create login/password to clear access to them.</p>
<p>From there, the super structured URLs make it easy to collect the logs for a given date.</p>
<p><script src="https://gist.github.com/rhumaric/1cbbc162d2b129b2910701b61d903382.js?file=ovh-download-logs.sh"></script></p>
<p>As for the Piwik import script, the credentials are kept out of the script. You’ll need to put the necessary <code>--user</code> and <code>--password</code> <code>curl</code> flags in a separate <code>.curlauth</code> file.</p>
<p>The different parts are ready, time to combine them together.</p>
<h2 id="setting-up-a-cron-job"><a class="headeranchor-link" href="#setting-up-a-cron-job" name="user-content-setting-up-a-cron-job"></a>Setting up a Cron job</h2>
<p><code>Cron</code> is a tool that schedules scripts to run at regular intervals. That’s what we’ll use to run the import every night. To make things simpler, one last script is needed, that will combine the two previous one and make the magic happen.</p>
<p><script src="https://gist.github.com/rhumaric/1cbbc162d2b129b2910701b61d903382.js?file=import-yesterdays-log.sh"></script></p>
<p>Now all the scripts are ready, the last steps start with uploading them to the server. Ideally, you want them in a folder that’s not accessible from the internet (or at least with no access to the <code>.*auth</code> files). Make sure they can be executed with <code>chmod a+x *.sh</code> inside the folder they’re stored. And finally, in the hosting admin panel, you’ll need to schedule a new job to run every day, using the path to the <code>import-yesterdays-log.sh</code> script.</p>
<p><em>Note:</em> You might want to test things out before setting up the Cron job. Quick catch there, it’s a bit more convoluted than SSHing to the server and running the last script from the command line, unfortunately. OVH seems to prevent network access to scripts on their shared hosting when run from an SSH connection. All is not lost, though! You can create a small PHP page running the import script and showing its output to try the script out.</p>
<p>Voila! Your shared hosting logs will get imported into Piwik every night and you can start analysing your traffic. If you need to <a href="mailto:hello@romaricpascal.is">Let me know how this worked for you</a> if you decide to set it up too. And if you have any question, of course, <a href="mailto:hello@romaricpascal.is">feel free to contact me</a>.</p>

]]></description>
		<guid ispermalink="false">/?p=600</guid>
		</item>
	</atom:link></channel>
</rss>
</body></html>